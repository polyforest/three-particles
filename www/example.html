<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Three Particles Example</title>
        <style>
            body,
            html {
                margin: 0;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }
            #mainCanvas {
                width: 100%;
                height: 100%;
                display: block;
                background-color: #191919;
            }
        </style>
        <script type="importmap">
            {
                "imports": {
                    "three": "https://unpkg.com/three@0.181.2/build/three.module.js",
                    "three/addons/": "https://unpkg.com/three@0.181.2/examples/jsm/",
                    "three-particles": "https://unpkg.com/three-particles@0.15.0/dist/index.js"
                }
            }
        </script>
    </head>
    <body>
        <canvas id="mainCanvas"></canvas>
        <script type="module">
            import {
                AmbientLight,
                Clock,
                Color,
                DirectionalLight,
                Fog,
                GridHelper,
                Mesh,
                MeshStandardMaterial,
                PerspectiveCamera,
                PlaneGeometry,
                Scene,
                Vector3,
                WebGLRenderer,
            } from 'three'
            import {
                ParticleEffect,
                ParticleEffectLoader,
            } from 'three-particles'
            import { OrbitControls } from 'three/addons/controls/OrbitControls.js'

            const camera = new PerspectiveCamera()
            camera.position.set(0, 5, 10)
            camera.lookAt(new Vector3(0, 0.2, 0))

            const scene = new Scene()
            scene.background = new Color(0x111111)
            scene.fog = new Fog(0x111111, 1, 30)

            const grid = new GridHelper(20, 20, 0x000000, 0xffffff)
            grid.material.opacity = 0.2
            grid.material.transparent = true
            scene.add(grid)

            const canvas = document.querySelector('#mainCanvas')

            const renderer = new WebGLRenderer({
                canvas,
                antialias: true,
            })
            renderer.setClearColor(0x191919)
            renderer.shadowMap.enabled = true

            // Lighting
            const dirLight = new DirectionalLight(0xffffff, 2)
            dirLight.position.set(3, 4, 2)
            dirLight.castShadow = true
            // Tweak shadow quality and camera bounds to cover our scene area
            const s = 5
            dirLight.shadow.camera.left = -s
            dirLight.shadow.camera.right = s
            dirLight.shadow.camera.top = s
            dirLight.shadow.camera.bottom = -s
            dirLight.shadow.mapSize.set(1024, 1024)
            scene.add(dirLight)
            scene.add(new AmbientLight(0xffffff, 0.2))

            // Ground to receive shadows
            const ground = new Mesh(
                new PlaneGeometry(20, 20),
                new MeshStandardMaterial({ color: 0x303030 }),
            )
            ground.rotation.x = -Math.PI / 2
            ground.position.y = -0.001
            ground.receiveShadow = true
            scene.add(ground)

            const controls = new OrbitControls(camera, renderer.domElement)

            // Update the camera and WebGLRenderer when the window resizes.
            function onResize() {
                const width = canvas.clientWidth
                const height = canvas.clientHeight
                renderer.setPixelRatio(window.devicePixelRatio)
                renderer.setSize(width, height, false)
                camera.aspect = width / height
                camera.updateProjectionMatrix()
            }

            window.addEventListener('resize', onResize)
            onResize()

            // Load the particle effect.
            let particleEffect = null
            const loader = new ParticleEffectLoader()

            const particleEffectUrl =
                'https://firebasestorage.googleapis.com/v0/b/three-particles.firebasestorage.app/o/effects%2FiU0h1i107OerR2pGyWTKWBjJ3xJ3%2Fpublic%2Fa9c7af6b-deba-4511-b4b8-6900f7e79fed-r1-cube-tornado.json?alt=media&token=7c5a5e71-9b24-473c-bf15-d52231c92c8e'

            loader
                .loadAsync(particleEffectUrl)
                .then((model) => {
                    particleEffect = new ParticleEffect(model)
                    scene.add(particleEffect)
                })
                .catch(console.error)

            const clock = new Clock()
            function render() {
                const dT = Math.min(clock.getDelta(), 0.1)
                controls.update()
                if (particleEffect) {
                    particleEffect.update(dT)
                }
                renderer.render(scene, camera)
            }

            clock.start()
            renderer.setAnimationLoop(render)
        </script>
        <script src="./codepen-helper.js"></script>
    </body>
</html>
